#!/usr/bin/env bash
#MISE description="Start MkDocs documentation server"

set -e

PIDFILE=".mkdocs.pid"

# Check if already running
if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "✗ MkDocs is already running (PID: $PID)"
        exit 1
    fi
fi

# Activate virtual environment if it exists
if [ -d "venv" ]; then
    source venv/bin/activate
fi

# Ensure necessary directories exist
mkdir -p ${MISE_CONFIG_ROOT}/backend/target/site/jacoco
mkdir -p ${MISE_CONFIG_ROOT}/frontend/coverage/frontend

# Get the local IP address
LOCAL_IP=$(hostname -I | awk '{print $1}')

echo "Starting MkDocs server on http://${LOCAL_IP}:8000"
nohup mkdocs serve --dev-addr="${LOCAL_IP}:8000" > ./docs/docs.log 2>&1 &
echo $! > "$PIDFILE"

echo "✓ MkDocs started (PID: $(cat $PIDFILE))"

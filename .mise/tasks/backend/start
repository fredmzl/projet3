#!/usr/bin/env bash
#MISE description="Start backend server"

set -e
PIDFILE="${MISE_CONFIG_ROOT}/.backend.pid"

# VÃ©rifier si dÃ©jÃ  lancÃ©
if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "âŒ Backend is already running (PID: $PID)"
        exit 1
    fi
fi


# Charger la configuration CORS si le fichier existe
if [ -f "${MISE_CONFIG_ROOT}/backend/.env.cors" ]; then
    echo "ðŸ“¥ Loading CORS configuration from .env.cors"
    source "${MISE_CONFIG_ROOT}/backend/.env.cors"
fi

# Configuration de l'URL de tÃ©lÃ©chargement
# Par dÃ©faut, utilise l'IP de la machine (dÃ©tectÃ©e automatiquement)
if [ -z "$DOWNLOAD_BASE_URL" ]; then
    # DÃ©tecter l'IP principale (premiÃ¨re IP non-localhost)
    HOST_IP=$(hostname -I | awk '{print $1}')
    export DOWNLOAD_BASE_URL="http://${HOST_IP}:3000/api/files/download"
    echo "ðŸ”— Download URL auto-configured: $DOWNLOAD_BASE_URL"
fi

# VÃ©rifier le port
if lsof -ti :3000 > /dev/null; then
    echo "âŒ Port 3000 already in use"
    exit 1
fi

# vÃ©rifier que le storage local existe
STORAGE_DIR="/var/datashare/storage"
if [ ! -d "$STORAGE_DIR" ]; then
    echo "ðŸ“ Creating local storage directory at $STORAGE_DIR"
    mkdir -p "$STORAGE_DIR"
fi

# dÃ©marrer le backend
cd "${MISE_CONFIG_ROOT}/backend" || exit 1
nohup mvn spring-boot:run > backend.log 2>&1 &
echo $! > "$PIDFILE"

echo "âœ… Backend started (PID: $(cat $PIDFILE)). Check backend.log for details."
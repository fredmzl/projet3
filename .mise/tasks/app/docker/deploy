#!/usr/bin/env bash
#MISE description="Deploy datashare application (build images + start containers)"
#MISE arg "--build" help="Build Docker images before starting containers"

set -e

cd ${MISE_CONFIG_ROOT} || exit 1

echo "ðŸš€ Deploying DataShare application..."
echo "================================================================"
echo ""

# Build des images Docker
echo "ðŸ”¨ Building Docker images..."
if [[ "$1" == "--build" ]] || [[ "$2" == "--build" ]]; then
    docker compose build
    echo "âœ… Docker images built successfully!"
else
    echo "â„¹ï¸ Skipping Docker image build."
fi
echo "================================================================" 
echo ""

# DÃ©marrer les conteneurs
echo "ðŸš€ Starting Docker containers..."
docker compose up -d
echo "âœ… Docker containers started successfully!"
echo "================================================================"
echo ""

# rediriger les logs des containers vers des fichiers
echo "ðŸ“¥ Redirecting container logs to files..."
mkdir -p ./logs
docker compose logs -f backend > ./logs/backend.log 2>&1 &
docker compose logs -f frontend > ./logs/frontend.log 2>&1 &
docker compose logs -f postgresql > ./logs/postgresql.log 2>&1 &
echo "âœ… Logs are being redirected to backend.log, frontend.log, and postgresql.log"
echo "=============================================================================="
echo ""

# Message de succÃ¨s
echo "ðŸŽ‰ DataShare application deployed successfully!"
echo "You can access the frontend at http://[your_ip]:80"
echo ""
echo "To stop the application, run: mise app:docker:destroy [--flush] [--rmi]"
echo "======================================================================="



#!/usr/bin/env bash
#MISE description="Check if running application is healthy"

set -e

echo "=========================================="
echo "üîç Checking DataShare Application Health"
echo "=========================================="
echo ""

BACKEND_OK=true
FRONTEND_OK=true
DB_OK=true

# Check PostgreSQL container
echo "üóÑÔ∏è  Checking PostgreSQL..."
if docker ps --format "{{.Names}}" | grep -q "backend-postgresql-1"; then
    if docker exec backend-postgresql-1 pg_isready -U postgres > /dev/null 2>&1; then
        echo "   ‚úÖ PostgreSQL is ready and accepting connections"
    else
        echo "   ‚ùå PostgreSQL container running but not ready"
        DB_OK=false
    fi
else
    echo "   ‚ùå PostgreSQL container not running"
    DB_OK=false
fi
echo ""

# Check Backend
echo "üì¶ Checking Backend (port 3000)..."
if ss -ltn | grep -q ":3000 "; then
    # Check health endpoint
    if curl -s -f http://localhost:3000/actuator/health > /dev/null 2>&1; then
        HEALTH_STATUS=$(curl -s http://localhost:3000/actuator/health | grep -o '"status":"[^"]*"' | cut -d'"' -f4)
        if [ "$HEALTH_STATUS" = "UP" ]; then
            echo "   ‚úÖ Backend is UP and healthy"
        else
            echo "   ‚ö†Ô∏è  Backend responding but status: $HEALTH_STATUS"
            BACKEND_OK=false
        fi
    else
        echo "   ‚ö†Ô∏è  Backend port open but not responding to health checks"
        BACKEND_OK=false
    fi
else
    echo "   ‚ùå Backend not running (port 3000 not in use)"
    BACKEND_OK=false
fi
echo ""

# Check Frontend
echo "üé® Checking Frontend (port 4200)..."
if ss -ltn | grep -q ":4200 "; then
    # Check if HTTP server responds
    if curl -s -f http://localhost:4200 > /dev/null 2>&1; then
        echo "   ‚úÖ Frontend is UP and serving"
    else
        echo "   ‚ö†Ô∏è  Frontend port open but not responding"
        FRONTEND_OK=false
    fi
else
    echo "   ‚ùå Frontend not running (port 4200 not in use)"
    FRONTEND_OK=false
fi
echo ""

# Overall status
echo "=========================================="
if [ "$DB_OK" = true ] && [ "$BACKEND_OK" = true ] && [ "$FRONTEND_OK" = true ]; then
    echo "‚úÖ All services are healthy!"
    echo "=========================================="
    echo ""
    echo "üìç Access points:"
    echo "   Backend:  http://localhost:3000"
    echo "   Frontend: http://localhost:4200"
    # echo "   API Docs: http://localhost:3000/swagger-ui.html"
    echo ""
    exit 0
else
    echo "‚ùå Some services are not healthy"
    echo "=========================================="
    echo ""
    echo "üìã Troubleshooting:"
    if [ "$DB_OK" = false ]; then
        echo "   Database: docker compose -f backend/compose.yaml up -d"
    fi
    if [ "$BACKEND_OK" = false ]; then
        echo "   Backend:  mise run backend:start"
        echo "             mise run backend:log (to view logs)"
    fi
    if [ "$FRONTEND_OK" = false ]; then
        echo "   Frontend: mise run frontend:start"
        echo "             mise run frontend:log (to view logs)"
    fi
    echo ""
    exit 1
fi

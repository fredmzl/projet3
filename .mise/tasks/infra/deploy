#!/usr/bin/env bash
#MISE description="Deploy datashare application (build images + start containers)"
#MISE arg "--build" help="Build Docker images before starting containers"

set -e

cd ${MISE_CONFIG_ROOT} || exit 1

echo "üöÄ Deploying DataShare application..."
echo "================================================================"
echo ""

# Build des images Docker
echo "üî® Building Docker images..."
if [[ "$1" == "--build" ]] || [[ "$2" == "--build" ]]; then
    docker compose build
    echo "‚úÖ Docker images built successfully!"
else
    echo "‚ÑπÔ∏è Skipping Docker image build."
fi
echo "================================================================" 
echo ""

# D√©marrer les conteneurs
echo "üöÄ Starting Docker containers..."
docker compose up -d
echo "‚úÖ Docker containers started successfully!"
echo "================================================================"
echo ""

# rediriger les logs des containers vers des fichiers
echo "üì• Redirecting container logs to files..."
mkdir -p ./logs
docker compose logs -f backend > ./logs/backend.log 2>&1 &
docker compose logs -f frontend > ./logs/frontend.log 2>&1 &
docker compose logs -f postgresql > ./logs/postgresql.log 2>&1 &
echo "‚úÖ Logs are being redirected to backend.log, frontend.log, and postgresql.log"
echo "=============================================================================="
echo ""

# Message de succ√®s
echo "üéâ DataShare application deployed successfully!"
echo ""
echo "‚ÑπÔ∏è  Note: Remember to enroll the DataShare intermediate CA certificate in your trusted certificate store if needed:"
echo "${MISE_CONFIG_ROOT}/docker/pki/intermediate/certs/intermediate_server_ca.cert.pem"
echo ""
echo "You can access the frontend at http://[your_ip]:443"
echo ""
echo "You can seed data by running: mise infra:bootstrap"
echo ""
echo "To stop the application, run: mise infra:destroy [--flush] [--rmi]"
echo "======================================================================="






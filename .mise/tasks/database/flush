#!/usr/bin/env bash
#MISE description="Flush backend database (destructive!)"
#MISE arg "--storage" help="Also delete all files in /var/datashare/storage"

set -e

# Check if --storage flag is provided
FLUSH_STORAGE=false
if [[ "$1" == "--storage" ]] || [[ "$2" == "--storage" ]]; then
    FLUSH_STORAGE=true
fi

if [ "$FLUSH_STORAGE" = true ]; then
    echo "‚ö†Ô∏è  This will delete ALL database data AND all storage files!"
else
    echo "‚ö†Ô∏è  This will delete ALL database data!"
fi
read -p "Are you sure? (yes/no): " confirmation

if [ "$confirmation" != "yes" ]; then
    echo "‚ùå Operation cancelled"
    exit 0
fi

cd "${MISE_CONFIG_ROOT}/backend" && docker compose down -v
echo "‚úÖ Database flushed"

if [ "$FLUSH_STORAGE" = true ]; then
    echo "üóëÔ∏è  Deleting storage files..."
    if [ -d "/var/datashare/storage" ]; then
        sudo rm -rf /var/datashare/storage/*
        echo "‚úÖ Storage flushed"
    else
        echo "‚ö†Ô∏è  Storage directory /var/datashare/storage does not exist"
    fi
fi
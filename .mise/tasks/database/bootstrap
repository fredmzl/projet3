#!/usr/bin/env bash
#MISE description="Bootstrap test data with multiple users and files"

set -e

API_URL="${API_URL:-http://localhost:3000}"
SCRIPT_PATH="${MISE_CONFIG_ROOT}/.mise/scripts/create-user-with-files.sh"

echo "=========================================="
echo "üöÄ Bootstrap test data for DataShare API"
echo "=========================================="
echo ""
echo "API URL: $API_URL"
echo ""

# V√©rifier que l'API est accessible
echo "üîç Checking API availability..."
if ! curl -s -f "$API_URL/actuator/health" > /dev/null 2>&1; then
    echo "‚ùå API is not accessible at $API_URL"
    echo "   Please start the backend first: mise backend:start"
    exit 1
fi
echo "‚úÖ API is running"
echo ""

# Cr√©er des donn√©es pour 3 utilisateurs de test
USERS=("alice" "bob" "john")

for user in "${USERS[@]}"; do
    echo "----------------------------------------"
    echo "üë§ Creating test data for: $user"
    echo "----------------------------------------"
    
    if [ -x "$SCRIPT_PATH" ]; then
        "$SCRIPT_PATH" "$user"
    else
        echo "‚ùå Script not found or not executable: $SCRIPT_PATH"
        exit 1
    fi
    
    echo ""
done

echo "=========================================="
echo "‚úÖ Bootstrap completed successfully!"
echo "=========================================="
echo ""
echo "üìä Summary:"
echo "   ‚Ä¢ Created 3 users: alice, bob, john"
echo "   ‚Ä¢ Each user has 3 files uploaded"
echo "   ‚Ä¢ Total: 9 files in the system"
echo ""
echo "üîó Test commands:"
echo "   # List all users in database:"
echo "   mise database:show \"SELECT id, login FROM users;\""
echo ""
echo "   # List all files in database:"
echo "   mise database:show \"SELECT id, original_filename, user_id, file_size FROM files;\""
echo ""
echo "   # Login as alice and get files:"
echo "   TOKEN=\$(curl -s -X POST \"$API_URL/api/auth/login\" -H \"Content-Type: application/json\" -d '{\"login\":\"alice@example.com\",\"password\":\"password123\"}' | jq -r '.token')"
echo "   curl -s -X GET \"$API_URL/api/files\" -H \"Authorization: Bearer \$TOKEN\" | jq ."
echo ""

#!/usr/bin/env bash
#MISE description="Seed database and run E2E tests"
set -e

PIDFILE="${MISE_CONFIG_ROOT}/.backend.pid"

# VÃ©rifier si le backend est dÃ©jÃ  lancÃ©
if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if ps -p "$PID" > /dev/null 2>&1; then
        echo "âœ… Backend is running (PID: $PID)"
    fi
else
    echo "Startinfg backend for E2E tests..."
    mise dev:backend:start
    # Attendre un peu pour s'assurer que le backend est bien lancÃ©
    sleep 5
fi


echo "ğŸš€ PrÃ©paration et exÃ©cution des tests E2E..."
echo "================================================================"
echo ""

# 1. Seed des donnÃ©es de test
echo "ğŸ“¦ Ã‰tape 1/2: Seed des donnÃ©es de test"
mise run dev:app:bootstrap

echo ""
echo "================================================================"
echo ""

# 2. ExÃ©cution des tests E2E
echo "ğŸ­ Ã‰tape 2/2: ExÃ©cution des tests E2E"
cd ${MISE_CONFIG_ROOT}/frontend || exit 1
npm run e2e

echo ""
echo "================================================================"
echo "âœ… Pipeline de tests E2E terminÃ© avec succÃ¨s!"

# Cas Pratique : Trivy scans

> Ce document pr√©sente des analyses r√©elles de vuln√©rabilit√© CVE CRITICAL d√©tect√©e lors du scan trivy sur les images docker du projet DataShare.

---
!!! info "Trivy propose diff√©rents types de scan"    
    - **Scan image docker** (utilis√© ici) : analyse les couches de l'image et les packages install√©s.
    - **Scan Dockerfile** (utilis√© ici) : analyse le fichier Dockerfile pour les mauvaises pratiques de s√©curit√©.
    - **Scan syst√®me de fichiers** : analyse un r√©pertoire local.
    - **Scan repository Git** : analyse le code source dans un d√©p√¥t Git.
    - **Scan Infrastructure as Code (IaC)** : analyse les fichiers IaC pour les mauvaises configurations de s√©curit√©.

## üîç D√©couverte de la Vuln√©rabilit√© : CVE-2024-47554 Backend

### Scan Trivy  

**Commande ex√©cut√©e** :
```bash
trivy image datashare-backend:latest
```

**R√©sultat du scan** :

| Library | Vulnerability | Severity | Status | Installed Version | Fixed Version | Title |
|---------|---------------|----------|--------|-------------------|---------------|-------|
| `commons-io:commons-io (app.jar)` | CVE-2024-47554 | **HIGH** | fixed | 2.13.0 | 2.14.0 | apache-commons-io: Possible denial of service attack on untrusted input to XmlStreamReader<br>https://avd.aquasec.com/nvd/cve-2024-47554 |


### üìä Analyse Initiale (via ![cvedetails](https://www.cvedetails.com/cve/CVE-2024-47554/))

| √âl√©ment | Valeur |
|---------|--------|
| **CVE ID** | CVE-2024-47554 |
| **S√©v√©rit√© CVSS** | 4.3 / 10.0 (MEDIUM) |
| **Composant** | `commons-io:commons-io (app.jar)` |
| **Date publication CVE** | 03 octobre 2024 |
| **Statut** | corrig√© √† partir de la version 2.14.0 |

---

### üîé Investigation : D'o√π vient cette d√©pendance ?

#### √âtape 1 : V√©rification dans pom.xml

```bash
grep -r "commons-io" backend/pom.xml
```

**R√©sultat** : Aucune d√©claration directe ‚ùå

‚û°Ô∏è **Hypoth√®se** : D√©pendance **transitive** (indirecte)

---

### √âtape 2 : Analyse de l'arbre de d√©pendances

```bash
mvn dependency:tree | grep -B5 "commons-io:commons-io"
```

**R√©sultat** :

```
[INFO] +- com.github.docker-java:docker-java-core:jar:3.4.0:test
[INFO] |  +- com.github.docker-java:docker-java-api:jar:3.4.0:test
[INFO] |  +- com.github.docker-java:docker-java-transport:jar:3.4.0:test
[INFO] |  +- org.slf4j:slf4j-api:jar:2.0.17:compile
[INFO] |  +- commons-io:commons-io:jar:2.13.0:compile  ‚ö†Ô∏è
```

---

### üõ°Ô∏è D√©tails de la Vuln√©rabilit√©

#### CVE-2024-47554 : Possible denial of service attack on untrusted input to XmlStreamReader

**Description officielle** (CVE Details) :

> Uncontrolled Resource Consumption vulnerability in Apache Commons IO. The org.apache.commons.io.input.XmlStreamReader class may excessively consume CPU resources when processing maliciously crafted input.

**Impact potentiel** :    
- ‚úÖ **D√©ni de service** : Exploitation via entr√©e XML malveillante   
- ‚ùå **Pas d'impact confidentialit√© ou int√©grit√©**  

**Score CVSS v3.1 : 4.3 (MEDIUM)**

| M√©trique | Valeur | Justification |
|----------|--------|---------------|
| Attack Vector | Network (N) | Via parsing XML from untrusted source |
| Attack Complexity | Low (L) | Simple XML input required |
| Privileges Required | None (N) | Aucune authentification requise |
| User Interaction | None (N) | Automatique lors du parsing |
| Confidentiality | None (N) | Pas d'impact confidentialit√© |
| Integrity | None (N) | Pas d'impact int√©grit√© |
| Availability | Low (L) | Possible DoS via CPU exhaustion |

---

### ‚úÖ Correction Appliqu√©e

Aucune, l'exploitability Score est faible (2.8).

---

### üìù Conclusion & Bilan
#### **Analyse CVSS CRITICAL ‚â† Impact R√©el Critique**

**D√©cision** : Bien que CVSS 4.3, le risque **r√©el** est **FAIBLE** pour DataShare.  
Nous pouvons remarquer √©galement une incoh√©rence entre le scan trivy (HIGH) et l'analyse CVSS (MEDIUM).  
Le scan maven du backend a remont√© √©galement cette CVE en MEDIUM. 

**Action** : Surveiller les futures versions de `commons-io` pour une correction.

---

## üîç D√©couverte de Misconfigurations (Dockerfile)

### Scan Trivy Config

**Commande ex√©cut√©e** :
```bash
trivy config backend/docker/Dockerfile
```

**R√©sultat du scan** :

```
Report Summary

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Target   ‚îÇ    Type    ‚îÇ Misconfigurations ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Dockerfile ‚îÇ dockerfile ‚îÇ         2         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Dockerfile (dockerfile)
Tests: 27 (SUCCESSES: 25, FAILURES: 2)
Failures: 2 (UNKNOWN: 0, LOW: 1, MEDIUM: 0, HIGH: 1, CRITICAL: 0)
```

### üìä Analyse des Misconfigurations D√©tect√©es

| Misconfiguration ID | S√©v√©rit√© | Description | Impact |
|---------------------|----------|-------------|--------|
| **AVD-DS-0002** | **HIGH** | Conteneur ex√©cut√© en tant que `root` | Container escape, privil√®ges excessifs |
| **AVD-DS-0026** | **LOW** | Absence de `HEALTHCHECK` | Monitoring insuffisant, orchestration limit√©e |

---

## üõ°Ô∏è D√©tails des Misconfigurations

### 1. AVD-DS-0002 (HIGH) : Ex√©cution Container en Root

**Description officielle** (Aqua Security) :

> Running containers with 'root' user can lead to a **container escape** situation. It is a best practice to run containers as non-root users, which can be done by adding a 'USER' statement to the Dockerfile.

**Risques identifi√©s** :

- üî¥ **Container Escape** : Si une CVE critique est exploit√©e dans l'application Java (ex: RCE), l'attaquant obtient un shell `root` dans le conteneur
- üî¥ **Escalade de privil√®ges** : Acc√®s root facilite l'exploitation de CVE kernel Docker ou failles runtime
- üü° **Principe du moindre privil√®ge** : Violation des best practices s√©curit√© (Defense in Depth)

**Vecteur d'attaque typique** :

1. Exploitation RCE via CVE application (ex: Spring Boot CVE-2022-22965)
2. Shell obtenu ‚Üí UID 0 (root) dans le conteneur
3. Exploitation CVE Docker runtime (ex: runc CVE-2019-5736) ‚Üí Escape vers host
4. Compromission totale serveur h√¥te ‚ò†Ô∏è

**Contexte DataShare** :

```dockerfile
# backend/docker/Dockerfile (avant correction)
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app
COPY --from=build /build/target/datashare-*.jar app.jar
RUN mkdir -p /var/datashare/storage && \
    chmod 777 /var/datashare/storage  # ‚ö†Ô∏è Permissions dangereuses
ENTRYPOINT ["java", "-jar", "app.jar"]  # ‚ö†Ô∏è Ex√©cution en root (UID 0)
```

**Analyse de l'impact r√©el** :

- ‚úÖ **Pas de montage volume host sensible** (`/var/datashare/storage` volume Docker interne)
- ‚úÖ **R√©seau bridge isol√©** (`datashare-net` non expos√© directement)
- ‚ö†Ô∏è **Mais risque subsiste** : Container escape possible via CVE runtime


---

### 2. AVD-DS-0026 (LOW) : Absence de HEALTHCHECK

**Description officielle** (Aqua Security) :

> You should add **HEALTHCHECK** instruction in your docker container images to perform the health check on running containers.

**Risques identifi√©s** :

- üü° **Monitoring insuffisant** : Docker/Kubernetes ne peut pas d√©tecter automatiquement les √©tats d'√©chec applicatifs (ex: deadlock, OOM silencieux)
- üü° **Orchestration limit√©e** : `docker-compose restart: unless-stopped` ne red√©marre pas en cas de crash applicatif sans exit code
- üü¢ **Impact faible** : MVP mono-serveur sans haute disponibilit√© requise

**Contexte DataShare** :

```yaml
# docker-compose.yml (sans healthcheck)
services:
  backend:
    image: datashare-backend:latest
    restart: unless-stopped  # ‚ö†Ô∏è Red√©marre uniquement si exit code ‚â† 0
    # Pas de healthcheck d√©fini
```

**Cas d'usage typique HEALTHCHECK** :

- Spring Boot Actuator `/actuator/health` ‚Üí HTTP 200 = healthy
- Test p√©riodique toutes les 30s
- Red√©marrage automatique apr√®s 3 √©checs cons√©cutifs

**S√©v√©rit√© contextualis√©e** : **LOW** maintenue (MVP, monitoring manuel acceptable)

---

## ‚úÖ Corrections Appliqu√©es

### Correction 1 : Cr√©ation Utilisateur Non-Root (AVD-DS-0002)

**Modification Dockerfile** :

```dockerfile
# ========================================
# Stage 2: Image finale avec JRE + user non-root
# ========================================
FROM eclipse-temurin:21-jre-alpine

WORKDIR /app

# Copier le JAR depuis l'√©tape de build
COPY --from=build /build/target/datashare-*.jar app.jar

# ‚úÖ Cr√©er utilisateur/groupe non-root
RUN addgroup -S datashare && \
    adduser -S datashare -G datashare && \
    mkdir -p /var/datashare/storage && \
    chown -R datashare:datashare /var/datashare && \
    chown -R datashare:datashare /app

EXPOSE 3000

# Variables d'environnement (inchang√©es)
ENV SPRING_PROFILES_ACTIVE=prod \
    SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/datashare \
    APP_STORAGE_PATH=/var/datashare/storage \
    CORS_ALLOWED_ORIGINS=http://localhost:4200,http://127.0.0.1:4200

# ‚úÖ Switch vers utilisateur non-root AVANT ENTRYPOINT
USER datashare

# Lancer l'application (maintenant en tant que datashare:datashare)
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**Changements cl√©s** :

1. **Cr√©ation groupe/utilisateur** : `addgroup -S datashare && adduser -S datashare -G datashare`
   - `-S` : Compte syst√®me (UID < 1000, pas de home, pas de password)
   - `datashare:datashare` ‚Üí UID/GID non-root (ex: 100:101)

2. **Permissions adapt√©es** : `chown -R datashare:datashare /var/datashare /app`
   - Suppression `chmod 777` (dangereux)
   - Ownership explicite user/group

3. **Switch USER** : `USER datashare` **AVANT** `ENTRYPOINT`
   - Process Java PID 1 ‚Üí UID datashare (non-root)
   - V√©rifiable : `docker exec <container> whoami` ‚Üí `datashare` ‚úÖ

**V√©rification post-correction** :

```bash
# Build + run
docker build -t datashare-backend:latest -f backend/docker/Dockerfile .
docker run -d --name test-backend datashare-backend:latest

# V√©rifier UID du process Java
docker exec test-backend ps aux
# UID  PID  CMD
# 100  1    java -jar app.jar  ‚úÖ Non-root

# V√©rifier permissions storage
docker exec test-backend ls -la /var/datashare/storage
# drwxr-xr-x 2 datashare datashare  ‚úÖ
```

---

### Correction 2 : Ajout HEALTHCHECK (AVD-DS-0026)

**Modification Dockerfile** :

```dockerfile
# ‚úÖ Healthcheck Spring Boot Actuator
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000/actuator/health || exit 1

# Lancer l'application
ENTRYPOINT ["java", "-jar", "app.jar"]
```

**Configuration Spring Boot requise** (`application.yml`) :

```yaml
management:
  endpoints:
    web:
      exposure:
        include: health  # Exposer endpoint /actuator/health
  endpoint:
    health:
      show-details: when-authorized  # D√©tails uniquement si JWT admin
```

**Param√®tres HEALTHCHECK** :

| Param√®tre | Valeur | Justification |
|-----------|--------|---------------|
| `--interval` | 30s | V√©rification toutes les 30 secondes (balance charge/r√©activit√©) |
| `--timeout` | 10s | Timeout requ√™te HTTP (application Spring Boot peut mettre 5-10s sous charge) |
| `--start-period` | 60s | P√©riode de gr√¢ce 60s (Spring Boot startup ~20-40s) |
| `--retries` | 3 | 3 √©checs cons√©cutifs avant marquage `unhealthy` (√©vite faux positifs) |

**Impact docker-compose** :

```yaml
services:
  backend:
    image: datashare-backend:latest
    healthcheck:
      # H√©rite du HEALTHCHECK Dockerfile
      disable: false  # Actif par d√©faut
    depends_on:
      postgres:
        condition: service_healthy  # Attend PostgreSQL healthy
```

**V√©rification post-correction** :

```bash
# Statut healthcheck
docker ps --format "table {{.Names}}\t{{.Status}}"
# NAMES            STATUS
# backend          Up 2 minutes (healthy)  ‚úÖ

# Logs healthcheck
docker inspect backend | jq '.[0].State.Health'
# {
#   "Status": "healthy",
#   "FailingStreak": 0,
#   "Log": [...]
# }
```

---

## üîÑ Re-scan Post-Corrections

**Commande** :

```bash
trivy config backend/docker/Dockerfile
```

**R√©sultat attendu** :

```
Dockerfile (dockerfile)
Tests: 27 (SUCCESSES: 27, FAILURES: 0)  ‚úÖ

0 misconfigurations found
```

---

## üìù Bilan et conclusions

### **Principe du Moindre Privil√®ge (Least Privilege)**

**Avant** : Process Java PID 1 ‚Üí UID 0 (root)  
**Apr√®s** : Process Java PID 1 ‚Üí UID 100 (datashare)

‚û°Ô∏è **R√©duction surface d'attaque** : Container escape ne donne plus shell root

### **Trivy Config vs Image Scan : Compl√©mentarit√©**

| Type Scan | Cible | D√©tecte |
|-----------|-------|---------|
| `trivy image` | Layers image Docker | CVE packages OS/runtime (Alpine, JRE) |
| `trivy config` | Dockerfile statique | Misconfigurations best practices (USER, HEALTHCHECK, secrets) |

‚û°Ô∏è **Les deux scans sont n√©cessaires** pour couverture compl√®te

### **HEALTHCHECK : Monitoring Proactif vs R√©actif**

**Sans HEALTHCHECK** :  
- Application deadlock ‚Üí Container `Up` mais inutilisable  
- D√©tection manuelle uniquement (logs, metrics externes)

**Avec HEALTHCHECK** :  
- Container marqu√© `unhealthy` automatiquement  
- Orchestrateur (K8s, Swarm) peut red√©marrer/router trafic  
- Monitoring simplifi√© (Prometheus blackbox_exporter)

---


